---
/**
 * Voice Widget Component - GENERATIVA
 *
 * Buton vocal integrat cu VAPI Web SDK pentru demo live.
 * Permite vizitatorilor să vorbească direct cu agentul AI.
 *
 * Se integrează în footer-ul ChatSimulator-ului.
 *
 * Tehnic:
 * - VAPI Web SDK încărcat via ESM (import dinamic, lazy la primul click)
 * - Labels pasate via data attributes (NU define:vars — incompatibil cu import())
 * - SPA cleanup pe navigare
 */

interface Props {
  locale?: 'ro' | 'en';
}

const { locale = 'ro' } = Astro.props;

const isEn = locale === 'en';
---

<button
  id="voice-call-btn"
  class="group flex items-center gap-2.5 w-full px-3 py-2 rounded-lg
         bg-gradient-to-r from-primary-500/8 to-accent-500/8
         hover:from-primary-500/15 hover:to-accent-500/15
         border border-primary-300/30 hover:border-primary-400/50
         transition-all duration-300 cursor-pointer"
  aria-label={isEn ? 'Talk to the AI agent' : 'Vorbește cu agentul AI'}
  data-cta={isEn ? 'Talk to the AI agent' : 'Vorbește cu agentul AI'}
  data-cta-active={isEn ? 'End call' : 'Oprește apelul'}
  data-connecting={isEn ? 'Connecting...' : 'Se conectează...'}
  data-connected={isEn ? 'Connected — speak now' : 'Conectat — vorbește acum'}
  data-listening={isEn ? 'Listening...' : 'Ascultă...'}
  data-processing={isEn ? 'Processing...' : 'Procesează...'}
  data-ended={isEn ? 'Call ended' : 'Apel încheiat'}
  data-error={isEn ? 'Connection error' : 'Eroare de conexiune'}
>
  <!-- Mic Icon (idle) -->
  <div id="voice-icon-idle" class="flex-shrink-0 w-7 h-7 rounded-full bg-gradient-to-br from-primary-400 to-accent-600 flex items-center justify-center shadow-sm group-hover:shadow-md transition-all duration-300">
    <svg class="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
    </svg>
  </div>

  <!-- Stop Icon (active, hidden by default) -->
  <div id="voice-icon-active" class="hidden flex-shrink-0 w-7 h-7 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-sm animate-pulse">
    <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24">
      <rect x="7" y="7" width="10" height="10" rx="1.5" />
    </svg>
  </div>

  <!-- Text -->
  <div class="flex flex-col text-left min-w-0">
    <span id="voice-cta-text" class="text-xs font-semibold text-neutral-700 group-hover:text-primary-700 transition-colors leading-tight">
      {isEn ? 'Talk to the AI agent' : 'Vorbește cu agentul AI'}
    </span>
    <span id="voice-status-text" class="text-[10px] text-neutral-400 leading-tight">
      Live demo
    </span>
  </div>
</button>

<script is:inline>
  (function() {
    'use strict';

    const VAPI_PUBLIC_KEY = '0a18ef59-2f8d-4e0a-aed3-1dfdee8f5caf';
    const ASSISTANT_ID = '6feee494-a480-433c-95ac-4899c467b972';

    let vapi = null;
    let isActive = false;
    let isInitialized = false;

    function init() {
      const btn = document.getElementById('voice-call-btn');
      if (!btn) return;

      // Read labels from data attributes
      const t = {
        cta: btn.dataset.cta || 'Vorbește cu agentul AI',
        ctaActive: btn.dataset.ctaActive || 'Oprește apelul',
        connecting: btn.dataset.connecting || 'Se conectează...',
        connected: btn.dataset.connected || 'Conectat — vorbește acum',
        listening: btn.dataset.listening || 'Ascultă...',
        processing: btn.dataset.processing || 'Procesează...',
        ended: btn.dataset.ended || 'Apel încheiat',
        error: btn.dataset.error || 'Eroare de conexiune',
      };

      const iconIdle = document.getElementById('voice-icon-idle');
      const iconActive = document.getElementById('voice-icon-active');
      const ctaText = document.getElementById('voice-cta-text');
      const statusText = document.getElementById('voice-status-text');

      if (!iconIdle || !iconActive || !ctaText || !statusText) return;

      function updateUI(state) {
        switch (state) {
          case 'idle':
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = 'Live demo';
            statusText.style.color = '';
            btn.classList.remove('ring-2', 'ring-red-400/50');
            break;
          case 'connecting':
            ctaText.textContent = t.connecting;
            statusText.textContent = '';
            btn.style.opacity = '0.7';
            btn.style.cursor = 'wait';
            break;
          case 'active':
            iconIdle.classList.add('hidden');
            iconActive.classList.remove('hidden');
            ctaText.textContent = t.ctaActive;
            statusText.textContent = t.connected;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.classList.add('ring-2', 'ring-red-400/50');
            break;
          case 'listening':
            statusText.textContent = t.listening;
            break;
          case 'processing':
            statusText.textContent = t.processing;
            break;
          case 'ended':
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            statusText.textContent = t.ended;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.classList.remove('ring-2', 'ring-red-400/50');
            setTimeout(() => updateUI('idle'), 3000);
            break;
          case 'error':
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = t.error;
            statusText.style.color = '#ef4444';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.classList.remove('ring-2', 'ring-red-400/50');
            setTimeout(() => {
              statusText.textContent = 'Live demo';
              statusText.style.color = '';
            }, 4000);
            break;
        }
      }

      async function initVapi() {
        if (isInitialized) return;
        try {
          // Use destructuring exactly like the working widget.js
          const { default: Vapi } = await import('https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/+esm');
          vapi = new Vapi(VAPI_PUBLIC_KEY);

          vapi.on('call-start', () => {
            isActive = true;
            updateUI('active');
          });

          vapi.on('call-end', () => {
            isActive = false;
            updateUI('ended');
          });

          vapi.on('speech-start', () => {
            if (isActive) updateUI('listening');
          });

          vapi.on('speech-end', () => {
            if (isActive) updateUI('processing');
          });

          vapi.on('error', (e) => {
            console.error('VAPI error:', e);
            isActive = false;
            updateUI('error');
          });

          isInitialized = true;
        } catch (e) {
          console.error('Failed to load VAPI SDK:', e);
          updateUI('error');
        }
      }

      btn.addEventListener('click', async () => {
        if (isActive && vapi) {
          vapi.stop();
          return;
        }

        updateUI('connecting');

        if (!isInitialized) {
          await initVapi();
        }

        if (vapi) {
          try {
            await vapi.start(ASSISTANT_ID);
          } catch (e) {
            console.error('VAPI start error:', e);
            isActive = false;
            updateUI('error');
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('astro:page-load', init);

    // Cleanup on SPA navigation
    document.addEventListener('astro:before-preparation', () => {
      if (vapi && isActive) {
        vapi.stop();
      }
    });
  })();
</script>
