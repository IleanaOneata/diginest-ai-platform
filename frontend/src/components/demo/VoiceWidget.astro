---
/**
 * Voice Widget Component - GENERATIVA
 *
 * Buton vocal integrat cu VAPI Web SDK pentru demo live.
 * Permite vizitatorilor să vorbească direct cu agentul AI.
 *
 * Funcționare:
 * - Click pe buton → se conectează la VAPI
 * - Agentul AI răspunde vocal în română
 * - Click din nou → oprește apelul
 *
 * Tehnic:
 * - VAPI Web SDK încărcat via ESM (import dinamic)
 * - Design integrat cu brand-ul GENERATIVA (gradient cyan→purple)
 * - Stări vizuale: idle, connecting, active
 * - Microfon necesită HTTPS (secure context)
 */

interface Props {
  locale?: 'ro' | 'en';
  className?: string;
}

const { locale = 'ro', className = '' } = Astro.props;

const labels = {
  ro: {
    cta: 'Vorbește cu agentul AI',
    ctaActive: 'Oprește apelul',
    connecting: 'Se conectează...',
    connected: 'Conectat — vorbește acum',
    listening: 'Ascultă...',
    processing: 'Procesează...',
    ended: 'Apel încheiat',
    error: 'Eroare de conexiune',
    micPermission: 'Permite accesul la microfon',
  },
  en: {
    cta: 'Talk to the AI agent',
    ctaActive: 'End call',
    connecting: 'Connecting...',
    connected: 'Connected — speak now',
    listening: 'Listening...',
    processing: 'Processing...',
    ended: 'Call ended',
    error: 'Connection error',
    micPermission: 'Allow microphone access',
  },
};

const t = labels[locale] || labels.ro;
---

<div class:list={["voice-widget", className]}>
  <!-- Voice Call Button -->
  <button
    id="voice-call-btn"
    class="group relative flex items-center gap-3 w-full px-5 py-3.5 rounded-xl
           bg-gradient-to-r from-primary-500/10 to-accent-500/10
           border border-primary-300/40
           hover:from-primary-500/15 hover:to-accent-500/15
           hover:border-primary-400/60 hover:shadow-lg hover:shadow-primary-500/10
           transition-all duration-300 cursor-pointer"
    aria-label={t.cta}
    data-locale={locale}
  >
    <!-- Mic Icon (idle state) -->
    <div id="voice-icon-idle" class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-accent-600 flex items-center justify-center shadow-md group-hover:shadow-lg group-hover:shadow-primary-500/20 transition-all duration-300">
      <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
      </svg>
    </div>

    <!-- Pulse Icon (active state - hidden by default) -->
    <div id="voice-icon-active" class="hidden flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-md animate-pulse">
      <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
        <rect x="6" y="6" width="12" height="12" rx="2" />
      </svg>
    </div>

    <!-- Text -->
    <div class="flex flex-col text-left min-w-0">
      <span id="voice-cta-text" class="text-sm font-semibold text-neutral-800 group-hover:text-primary-700 transition-colors">
        {t.cta}
      </span>
      <span id="voice-status-text" class="text-xs text-neutral-500">
        Live demo
      </span>
    </div>

    <!-- Arrow / indicator -->
    <div id="voice-arrow" class="ml-auto flex-shrink-0">
      <svg class="w-4 h-4 text-neutral-400 group-hover:text-primary-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
      </svg>
    </div>
  </button>
</div>

<script define:vars={{ labels }}>
  (function() {
    'use strict';

    const VAPI_PUBLIC_KEY = '0a18ef59-2f8d-4e0a-aed3-1dfdee8f5caf';
    const ASSISTANT_ID = '6feee494-a480-433c-95ac-4899c467b972';

    let vapi = null;
    let isActive = false;
    let isInitialized = false;

    function init() {
      const btn = document.getElementById('voice-call-btn');
      if (!btn) return;

      const locale = btn.dataset.locale || 'ro';
      const t = labels[locale] || labels.ro;

      const iconIdle = document.getElementById('voice-icon-idle');
      const iconActive = document.getElementById('voice-icon-active');
      const ctaText = document.getElementById('voice-cta-text');
      const statusText = document.getElementById('voice-status-text');
      const arrow = document.getElementById('voice-arrow');

      function updateUI(state) {
        switch (state) {
          case 'idle':
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = 'Live demo';
            arrow.classList.remove('hidden');
            btn.classList.remove('ring-2', 'ring-red-400/50', 'from-red-500/10', 'to-red-500/10', 'border-red-300/50');
            btn.classList.add('from-primary-500/10', 'to-accent-500/10', 'border-primary-300/40');
            break;
          case 'connecting':
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.connecting;
            statusText.textContent = '';
            arrow.classList.add('hidden');
            btn.style.opacity = '0.7';
            btn.style.cursor = 'wait';
            break;
          case 'active':
            iconIdle.classList.add('hidden');
            iconActive.classList.remove('hidden');
            ctaText.textContent = t.ctaActive;
            statusText.textContent = t.connected;
            arrow.classList.add('hidden');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.classList.remove('from-primary-500/10', 'to-accent-500/10', 'border-primary-300/40');
            btn.classList.add('ring-2', 'ring-red-400/50', 'from-red-500/10', 'to-red-500/10', 'border-red-300/50');
            break;
          case 'listening':
            statusText.textContent = t.listening;
            break;
          case 'processing':
            statusText.textContent = t.processing;
            break;
          case 'ended':
            statusText.textContent = t.ended;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            setTimeout(() => updateUI('idle'), 3000);
            break;
          case 'error':
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = t.error;
            statusText.style.color = '#ef4444';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            arrow.classList.remove('hidden');
            btn.classList.remove('ring-2', 'ring-red-400/50', 'from-red-500/10', 'to-red-500/10', 'border-red-300/50');
            btn.classList.add('from-primary-500/10', 'to-accent-500/10', 'border-primary-300/40');
            setTimeout(() => {
              statusText.textContent = 'Live demo';
              statusText.style.color = '';
            }, 4000);
            break;
        }
      }

      async function initVapi() {
        if (isInitialized) return;
        try {
          const module = await import('https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/+esm');
          const Vapi = module.default || module.Vapi || module;
          vapi = new Vapi(VAPI_PUBLIC_KEY);

          vapi.on('call-start', () => {
            isActive = true;
            updateUI('active');
          });

          vapi.on('call-end', () => {
            isActive = false;
            updateUI('ended');
          });

          vapi.on('speech-start', () => {
            if (isActive) updateUI('listening');
          });

          vapi.on('speech-end', () => {
            if (isActive) updateUI('processing');
          });

          vapi.on('error', (e) => {
            console.error('VAPI error:', e);
            isActive = false;
            updateUI('error');
          });

          isInitialized = true;
        } catch (e) {
          console.error('Failed to load VAPI SDK:', e);
          updateUI('error');
        }
      }

      btn.addEventListener('click', async () => {
        if (isActive && vapi) {
          vapi.stop();
          return;
        }

        updateUI('connecting');

        if (!isInitialized) {
          await initVapi();
        }

        if (vapi) {
          try {
            await vapi.start(ASSISTANT_ID);
          } catch (e) {
            console.error('VAPI start error:', e);
            isActive = false;
            updateUI('error');
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('astro:page-load', init);

    // Cleanup on SPA navigation
    document.addEventListener('astro:before-preparation', () => {
      if (vapi && isActive) {
        vapi.stop();
      }
    });
  })();
</script>
