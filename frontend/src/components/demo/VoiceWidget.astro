---
/**
 * Voice Widget Component - GENERATIVA
 *
 * Buton vocal MARE, circular, cu inele animate (sonar/radar).
 * Element central și dominant în Hero section.
 *
 * Design:
 * - Buton circular mare cu gradient brand (cyan→purple)
 * - 3 inele concentrice animate cu timing decalat
 * - Text descriptiv sub buton
 * - Badge hint cu ping indicator
 *
 * Tehnic:
 * - VAPI Web SDK încărcat via ESM (import dinamic, lazy la primul click)
 * - Labels pasate via data attributes (NU define:vars — incompatibil cu import())
 * - CSS @keyframes pentru ring pulse animations
 * - prefers-reduced-motion: animații dezactivate
 * - SPA cleanup pe navigare
 */

interface Props {
  locale?: 'ro' | 'en';
}

const { locale = 'ro' } = Astro.props;

const isEn = locale === 'en';

// VAPI credentials — read from env vars (fallback to hardcoded for dev)
// These are PUBLIC keys (safe for client-side), but stored in env for easy rotation
const vapiPublicKey = import.meta.env.PUBLIC_VAPI_PUBLIC_KEY || 'b2bf9912-fd4e-44f9-9918-80534970bf59';
const vapiAssistantId = import.meta.env.PUBLIC_VAPI_ASSISTANT_ID || '4f9646d7-8f0c-4ed3-86a7-ea9f0d7122a8';
const vapiApiUrl = import.meta.env.PUBLIC_VAPI_API_URL || 'https://api.eu.vapi.ai';
---

<div
  class="voice-widget-container flex flex-col items-center gap-5 w-[17rem] md:w-[20rem] lg:w-[22rem]"
  data-cta={isEn ? 'Talk to your assistant' : 'Vorbește cu asistentul tău'}
  data-cta-active={isEn ? 'End call' : 'Oprește apelul'}
  data-connecting={isEn ? 'Connecting...' : 'Se conectează...'}
  data-connected={isEn ? 'Connected — speak now' : 'Conectat — vorbește acum'}
  data-listening={isEn ? 'Listening...' : 'Ascultă...'}
  data-processing={isEn ? 'Processing...' : 'Procesează...'}
  data-ended={isEn ? 'Call ended' : 'Apel încheiat'}
  data-error={isEn ? 'Connection error' : 'Eroare de conexiune'}
  data-hint-idle={isEn ? 'Live demo · Listen how it sounds' : 'Demo live · Ascultă cum sună'}
  data-vapi-key={vapiPublicKey}
  data-vapi-assistant={vapiAssistantId}
  data-vapi-url={vapiApiUrl}
>
  <!-- Animated Ring Container -->
  <div class="voice-rings-wrapper relative flex items-center justify-center w-40 h-40 md:w-48 md:h-48 lg:w-56 lg:h-56 overflow-visible">
    <!-- Ring 3 - Outermost (slowest, largest) -->
    <div class="voice-ring voice-ring-3 absolute inset-0 rounded-full border-2 border-accent-400/30 animate-ring-pulse-3"></div>

    <!-- Ring 2 - Middle -->
    <div class="voice-ring voice-ring-2 absolute inset-0 rounded-full border-2 border-accent-500/40 animate-ring-pulse-2"></div>

    <!-- Ring 1 - Innermost (fastest, smallest) -->
    <div class="voice-ring voice-ring-1 absolute inset-0 rounded-full border-2 border-accent-500/50 animate-ring-pulse-1"></div>

    <!-- Main Button -->
    <button
      id="voice-call-btn"
      class="voice-button relative group
             w-28 h-28 md:w-32 md:h-32 lg:w-36 lg:h-36
             rounded-full
             bg-gradient-to-br from-accent-400 to-accent-600
             shadow-2xl shadow-accent-500/30
             hover:shadow-[0_25px_60px_-12px_rgba(245,158,11,0.5)]
             transition-shadow duration-500
             flex items-center justify-center
             cursor-pointer
             focus:outline-none focus:ring-4 focus:ring-accent-400/50"
      aria-label={isEn ? 'Talk to your assistant' : 'Vorbește cu asistentul tău'}
    >
      <!-- Mic Icon (idle) -->
      <svg
        id="voice-icon-idle"
        class="w-12 h-12 md:w-14 md:h-14 lg:w-16 lg:h-16 text-white drop-shadow-lg transition-transform duration-300 group-hover:scale-110"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
      </svg>

      <!-- Stop Icon (active, hidden by default) -->
      <svg
        id="voice-icon-active"
        class="hidden w-12 h-12 md:w-14 md:h-14 lg:w-16 lg:h-16 text-white drop-shadow-lg"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <rect x="6" y="6" width="12" height="12" rx="2" />
      </svg>

      <!-- Inner Glow Effect (hover) -->
      <div class="absolute inset-0 rounded-full bg-white/0 group-hover:bg-white/15 transition-all duration-500 pointer-events-none"></div>
    </button>
  </div>

  <!-- Text Labels (min-h prevents layout shift on state changes) -->
  <div class="text-center space-y-1.5 min-h-[3.5rem]">
    <h3
      id="voice-cta-text"
      class="text-lg md:text-xl lg:text-2xl font-bold text-neutral-750 transition-colors"
    >
      {isEn ? 'Talk to your assistant' : 'Vorbește cu asistentul tău'}
    </h3>
    <p
      id="voice-status-text"
      class="text-sm md:text-base text-neutral-500 min-h-[1.25rem]"
    >
      {isEn ? 'Live demo · Listen how it sounds' : 'Demo live · Ascultă cum sună'}
    </p>
  </div>

  <!-- Visual Hint Badge -->
  <div class="voice-hint flex items-center gap-2 px-4 py-2 bg-accent-100/80 backdrop-blur-sm rounded-full border border-accent-200/50 transition-all duration-300">
    <span class="relative flex h-2 w-2">
      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent-500 opacity-75"></span>
      <span class="relative inline-flex rounded-full h-2 w-2 bg-accent-600"></span>
    </span>
    <span class="text-xs md:text-sm font-medium text-accent-700">
      {isEn ? 'Try the live voice demo' : 'Încearcă demo-ul vocal'}
    </span>
  </div>
</div>

<style>
  /* ===== Ring Pulse Animations ===== */
  @keyframes ringPulse1 {
    0% {
      transform: scale(0.75);
      opacity: 0.6;
    }
    100% {
      transform: scale(1.15);
      opacity: 0;
    }
  }

  @keyframes ringPulse2 {
    0% {
      transform: scale(0.75);
      opacity: 0.45;
    }
    100% {
      transform: scale(1.3);
      opacity: 0;
    }
  }

  @keyframes ringPulse3 {
    0% {
      transform: scale(0.75);
      opacity: 0.3;
    }
    100% {
      transform: scale(1.45);
      opacity: 0;
    }
  }

  .animate-ring-pulse-1 {
    animation: ringPulse1 2.5s ease-out infinite;
  }
  .animate-ring-pulse-2 {
    animation: ringPulse2 2.5s ease-out infinite 0.4s;
  }
  .animate-ring-pulse-3 {
    animation: ringPulse3 2.5s ease-out infinite 0.8s;
  }

  /* ===== Hover: accelerate rings ===== */
  .voice-widget-container:hover .voice-ring {
    animation-duration: 1.6s;
  }

  /* ===== Active state: red rings ===== */
  .voice-widget-container.voice-active .voice-ring {
    border-color: rgba(239, 68, 68, 0.5);
    animation-duration: 1.2s;
  }

  .voice-widget-container.voice-active .voice-button {
    background: linear-gradient(to bottom right, #ef4444, #dc2626);
    box-shadow: 0 25px 50px -12px rgba(239, 68, 68, 0.4);
  }

  /* ===== Hide hint when active (visibility keeps layout space) ===== */
  .voice-widget-container.voice-active .voice-hint {
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
  }

  /* ===== Reduced motion ===== */
  @media (prefers-reduced-motion: reduce) {
    .voice-ring {
      animation: none !important;
    }
    .voice-button {
      transition: none !important;
    }
  }
</style>

<script is:inline>
  (function() {
    'use strict';

    // Read from data attributes (set by Astro from env vars)
    var containerEl = document.querySelector('.voice-widget-container');
    var VAPI_PUBLIC_KEY = containerEl ? containerEl.dataset.vapiKey : '';
    var ASSISTANT_ID = containerEl ? containerEl.dataset.vapiAssistant : '';
    var VAPI_API_URL = containerEl ? containerEl.dataset.vapiUrl : 'https://api.eu.vapi.ai';

    var vapi = null;
    var isActive = false;
    var isInitialized = false;

    function init() {
      var container = document.querySelector('.voice-widget-container');
      var btn = document.getElementById('voice-call-btn');
      if (!btn || !container) return;

      // Read labels from data attributes on container
      var t = {
        cta: container.dataset.cta || 'Vorbește cu agentul AI',
        ctaActive: container.dataset.ctaActive || 'Oprește apelul',
        connecting: container.dataset.connecting || 'Se conectează...',
        connected: container.dataset.connected || 'Conectat — vorbește acum',
        listening: container.dataset.listening || 'Ascultă...',
        processing: container.dataset.processing || 'Procesează...',
        ended: container.dataset.ended || 'Apel încheiat',
        error: container.dataset.error || 'Eroare de conexiune',
        hintIdle: container.dataset.hintIdle || 'Live demo · Click pentru a începe',
      };

      var iconIdle = document.getElementById('voice-icon-idle');
      var iconActive = document.getElementById('voice-icon-active');
      var ctaText = document.getElementById('voice-cta-text');
      var statusText = document.getElementById('voice-status-text');

      if (!iconIdle || !iconActive || !ctaText || !statusText) return;

      function updateUI(state) {
        switch (state) {
          case 'idle':
            container.classList.remove('voice-active');
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = t.hintIdle;
            statusText.style.color = '';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            break;
          case 'connecting':
            ctaText.textContent = t.connecting;
            statusText.textContent = '';
            btn.style.opacity = '0.7';
            btn.style.cursor = 'wait';
            break;
          case 'active':
            container.classList.add('voice-active');
            iconIdle.classList.add('hidden');
            iconActive.classList.remove('hidden');
            ctaText.textContent = t.ctaActive;
            statusText.textContent = t.connected;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            break;
          case 'listening':
            statusText.textContent = t.listening;
            break;
          case 'processing':
            statusText.textContent = t.processing;
            break;
          case 'ended':
            container.classList.remove('voice-active');
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = t.ended;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            setTimeout(function() { updateUI('idle'); }, 3000);
            break;
          case 'error':
            container.classList.remove('voice-active');
            iconIdle.classList.remove('hidden');
            iconActive.classList.add('hidden');
            ctaText.textContent = t.cta;
            statusText.textContent = t.error;
            statusText.style.color = '#ef4444';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            setTimeout(function() {
              statusText.textContent = t.hintIdle;
              statusText.style.color = '';
            }, 4000);
            break;
        }
      }

      // Cached VAPI constructor (loaded once, reusable)
      var VapiConstructor = null;

      // Pinned SDK version for cache stability (no @latest resolution delay)
      var SDK_URL = 'https://cdn.jsdelivr.net/npm/@vapi-ai/web@2.5.2/+esm';

      function loadSdk() {
        if (VapiConstructor) return Promise.resolve(VapiConstructor);
        return import(SDK_URL)
          .then(function(module) {
            var VapiModule = module.default || module;
            VapiConstructor = (typeof VapiModule === 'function')
              ? VapiModule
              : (VapiModule.default || VapiModule.Vapi || VapiModule);
            return VapiConstructor;
          });
      }

      function wireVapiEvents() {
        if (!vapi) return;
        vapi.on('call-start', function() {
          isActive = true;
          updateUI('active');
        });
        vapi.on('call-end', function() {
          isActive = false;
          updateUI('ended');
        });
        vapi.on('speech-start', function() {
          if (isActive) updateUI('listening');
        });
        vapi.on('speech-end', function() {
          if (isActive) updateUI('processing');
        });
        vapi.on('error', function(e) {
          console.error('VAPI error:', e);
          isActive = false;
          isInitialized = false;
          updateUI('error');
        });
      }

      function createVapiInstance() {
        // Reset any previous instance
        if (vapi) {
          try { vapi.stop(); } catch(e) { /* ignore */ }
          vapi = null;
        }
        isInitialized = false;
        isActive = false;

        return loadSdk().then(function(Vapi) {
          vapi = new Vapi(VAPI_PUBLIC_KEY, VAPI_API_URL);
          wireVapiEvents();
          isInitialized = true;
        });
      }

      // Eagerly preload SDK + pre-create VAPI instance when widget is visible
      // This eliminates all latency on first click (SDK + constructor already done)
      var preloadObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            createVapiInstance().catch(function() { /* silent preload fail is OK */ });
            preloadObserver.disconnect();
          }
        });
      }, { threshold: 0.1 });
      preloadObserver.observe(container);

      btn.addEventListener('click', function() {
        if (isActive && vapi) {
          vapi.stop();
          return;
        }

        updateUI('connecting');

        // If already pre-initialized, start immediately
        // If not (first time load or after error), create fresh instance first
        var ready = isInitialized ? Promise.resolve() : createVapiInstance();

        ready
          .then(function() {
            if (vapi) {
              return vapi.start(ASSISTANT_ID);
            }
          })
          .catch(function(e) {
            console.error('VAPI error:', e);
            isActive = false;
            isInitialized = false;
            updateUI('error');
          });
      });
    }

    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('astro:page-load', init);

    // Cleanup on SPA navigation
    document.addEventListener('astro:before-preparation', function() {
      if (vapi && isActive) {
        try { vapi.stop(); } catch(e) { /* ignore */ }
      }
    });
  })();
</script>
