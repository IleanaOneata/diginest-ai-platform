---
/**
 * Header Component — Main navigation header
 * GENERATIVA — AI Agents Platform
 *
 * Features:
 * - Sticky header with blur effect on scroll
 * - Responsive navigation with mobile menu
 * - Language switcher
 * - CTA button
 */

import { getTranslations, type Locale, buildLocalePath } from '@i18n/index';
import LanguageSwitcher from './LanguageSwitcher.astro';
import Button from './Button.astro';
import Logo from './Logo.astro';

interface Props {
  locale: Locale;
  currentPath: string;
}

const { locale, currentPath } = Astro.props;
const t = getTranslations(locale);

// Navigation items
const navItems = [
  {
    label: t.nav.services,
    href: buildLocalePath('/', locale) + '#services',
    hasDropdown: true,
    items: [
      { label: t.services.automation.title, href: buildLocalePath('/servicii/automatizare-procese/', locale) },
      { label: t.services.conversational.title, href: buildLocalePath('/servicii/agenti-conversationali/', locale) },
      { label: t.services.integrations.title, href: buildLocalePath('/servicii/integrari-ai/', locale) },
    ],
  },
  { label: t.nav.about, href: buildLocalePath('/despre/', locale) },
  { label: t.nav.contact, href: buildLocalePath('/contact/', locale) },
];

// Adjust paths for English
const navItemsAdjusted = locale === 'en' ? navItems.map(item => ({
  ...item,
  href: item.href.replace('/servicii/', '/services/')
    .replace('/despre/', '/about/')
    .replace('/automatizare-procese/', '/process-automation/')
    .replace('/agenti-conversationali/', '/conversational-agents/')
    .replace('/integrari-ai/', '/ai-integrations/'),
  items: item.items?.map(subItem => ({
    ...subItem,
    href: subItem.href.replace('/servicii/', '/services/')
      .replace('/automatizare-procese/', '/process-automation/')
      .replace('/agenti-conversationali/', '/conversational-agents/')
      .replace('/integrari-ai/', '/ai-integrations/'),
  })),
})) : navItems;

const ctaHref = buildLocalePath('/demo/', locale) + '?source=nav';
---

<header
  id="site-header"
  class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-b border-neutral-200 transition-all duration-300"
>
  <div class="container-lg">
    <nav class="flex items-center justify-between h-16 lg:h-20" aria-label="Main navigation">
      <!-- Logo GENERATIVA -->
      <a
        href={buildLocalePath('/', locale)}
        class="flex items-center hover:opacity-90 transition-opacity"
        aria-label="GENERATIVA - Home"
      >
        <Logo size="md" showText={true} variant="default" />
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center gap-1">
        {navItemsAdjusted.map((item) => (
          item.hasDropdown ? (
            <div class="relative" id="services-dropdown-container">
              <button
                class="flex items-center gap-1 px-4 py-2 text-neutral-600 hover:text-neutral-900 font-medium transition-colors"
                aria-expanded="false"
                aria-haspopup="true"
                aria-controls="services-dropdown"
                id="services-dropdown-button"
              >
                {item.label}
                <svg class="w-4 h-4 transition-transform" id="services-dropdown-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <!-- Dropdown menu (WAI-ARIA Menu Button pattern) -->
              <div
                class="absolute top-full left-0 pt-2 opacity-0 invisible transition-all duration-200"
                id="services-dropdown"
                role="menu"
                aria-labelledby="services-dropdown-button"
              >
                <div class="bg-white rounded-xl shadow-soft border border-neutral-200 py-2 min-w-[220px]">
                  {item.items?.map((subItem) => (
                    <a
                      href={subItem.href}
                      class="block px-4 py-2.5 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-50 focus:bg-neutral-50 focus:text-neutral-900 focus:outline-none transition-colors"
                      role="menuitem"
                      tabindex="-1"
                    >
                      {subItem.label}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <a
              href={item.href}
              class:list={[
                'px-4 py-2 font-medium transition-colors',
                currentPath.startsWith(item.href)
                  ? 'text-neutral-900'
                  : 'text-neutral-600 hover:text-neutral-900',
              ]}
            >
              {item.label}
            </a>
          )
        ))}
      </div>

      <!-- Right side: Language + CTA -->
      <div class="flex items-center gap-4">
        <LanguageSwitcher locale={locale} currentPath={currentPath} />

        <Button
          href={ctaHref}
          variant="gradient"
          size="sm"
          class="hidden sm:inline-flex"
        >
          {t.nav.cta}
        </Button>

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-button"
          type="button"
          class="lg:hidden p-2 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors"
          aria-expanded="false"
          aria-controls="mobile-menu"
          aria-label="Toggle menu"
        >
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Navigation -->
  <div
    id="mobile-menu"
    class="hidden lg:hidden border-t border-neutral-200 bg-white"
  >
    <div class="container-lg py-4 space-y-1">
      {navItemsAdjusted.map((item) => (
        item.hasDropdown ? (
          <div class="space-y-1">
            <div class="px-4 py-2 font-medium text-neutral-900">
              {item.label}
            </div>
            {item.items?.map((subItem) => (
              <a
                href={subItem.href}
                class="block px-6 py-2 text-neutral-600 hover:text-neutral-900 hover:bg-neutral-50 rounded-lg transition-colors"
              >
                {subItem.label}
              </a>
            ))}
          </div>
        ) : (
          <a
            href={item.href}
            class="block px-4 py-2 font-medium text-neutral-600 hover:text-neutral-900 hover:bg-neutral-50 rounded-lg transition-colors"
          >
            {item.label}
          </a>
        )
      ))}

      <div class="pt-4 px-4">
        <Button href={ctaHref} variant="gradient" class="w-full justify-center">
          {t.nav.cta}
        </Button>
      </div>
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-16 lg:h-20"></div>

<script>
  function initHeader() {
    // ─── Header scroll shadow ───
    const header = document.getElementById('site-header');
    if (header) {
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 100) {
          header.classList.add('shadow-soft');
        } else {
          header.classList.remove('shadow-soft');
        }
      });
    }

    // ─── Desktop dropdown (WAI-ARIA Menu Button pattern) ───
    const dropdownContainer = document.getElementById('services-dropdown-container');
    const dropdownButton = document.getElementById('services-dropdown-button') as HTMLButtonElement | null;
    const dropdownMenu = document.getElementById('services-dropdown');
    const dropdownChevron = document.getElementById('services-dropdown-chevron');

    if (dropdownContainer && dropdownButton && dropdownMenu) {
      const menuItems = dropdownMenu.querySelectorAll<HTMLAnchorElement>('[role="menuitem"]');

      function openDropdown() {
        dropdownButton!.setAttribute('aria-expanded', 'true');
        dropdownMenu!.classList.remove('opacity-0', 'invisible');
        dropdownMenu!.classList.add('opacity-100', 'visible');
        if (dropdownChevron) dropdownChevron.classList.add('rotate-180');
      }

      function closeDropdown() {
        dropdownButton!.setAttribute('aria-expanded', 'false');
        dropdownMenu!.classList.add('opacity-0', 'invisible');
        dropdownMenu!.classList.remove('opacity-100', 'visible');
        if (dropdownChevron) dropdownChevron.classList.remove('rotate-180');
      }

      function isOpen(): boolean {
        return dropdownButton!.getAttribute('aria-expanded') === 'true';
      }

      function focusMenuItem(index: number) {
        if (menuItems.length === 0) return;
        const clamped = Math.max(0, Math.min(index, menuItems.length - 1));
        menuItems[clamped].focus();
      }

      function getFocusedIndex(): number {
        const active = document.activeElement;
        for (let i = 0; i < menuItems.length; i++) {
          if (menuItems[i] === active) return i;
        }
        return -1;
      }

      // Mouse: hover open/close
      dropdownContainer.addEventListener('mouseenter', openDropdown);
      dropdownContainer.addEventListener('mouseleave', closeDropdown);

      // Button click toggle
      dropdownButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (isOpen()) {
          closeDropdown();
        } else {
          openDropdown();
          focusMenuItem(0);
        }
      });

      // Keyboard on button
      dropdownButton.addEventListener('keydown', (e) => {
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            openDropdown();
            focusMenuItem(0);
            break;
          case 'ArrowUp':
            e.preventDefault();
            openDropdown();
            focusMenuItem(menuItems.length - 1);
            break;
          case 'Escape':
            if (isOpen()) {
              e.preventDefault();
              closeDropdown();
              dropdownButton!.focus();
            }
            break;
        }
      });

      // Keyboard within menu items
      menuItems.forEach((item) => {
        item.addEventListener('keydown', (e) => {
          const idx = getFocusedIndex();
          switch (e.key) {
            case 'ArrowDown':
              e.preventDefault();
              focusMenuItem(idx < menuItems.length - 1 ? idx + 1 : 0);
              break;
            case 'ArrowUp':
              e.preventDefault();
              focusMenuItem(idx > 0 ? idx - 1 : menuItems.length - 1);
              break;
            case 'Home':
              e.preventDefault();
              focusMenuItem(0);
              break;
            case 'End':
              e.preventDefault();
              focusMenuItem(menuItems.length - 1);
              break;
            case 'Escape':
              e.preventDefault();
              closeDropdown();
              dropdownButton!.focus();
              break;
            case 'Tab':
              // Let Tab proceed naturally; close dropdown
              closeDropdown();
              break;
          }
        });
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (isOpen() && !dropdownContainer!.contains(e.target as Node)) {
          closeDropdown();
        }
      });

      // Close when focus leaves the dropdown entirely
      dropdownContainer.addEventListener('focusout', (e) => {
        const related = (e as FocusEvent).relatedTarget as Node | null;
        if (related && !dropdownContainer!.contains(related)) {
          closeDropdown();
        }
      });
    }

    // ─── Mobile menu ───
    const mobileMenuButton = document.getElementById('mobile-menu-button') as HTMLButtonElement | null;
    const mobileMenu = document.getElementById('mobile-menu');

    if (mobileMenuButton && mobileMenu) {
      // Clone to remove stale listeners from previous SPA navigations
      const newButton = mobileMenuButton.cloneNode(true) as HTMLButtonElement;
      mobileMenuButton.parentNode?.replaceChild(newButton, mobileMenuButton);

      function closeMobileMenu() {
        newButton.setAttribute('aria-expanded', 'false');
        mobileMenu!.classList.add('hidden');
        const icon = newButton.querySelector('svg');
        if (icon) {
          icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />';
        }
      }

      function isMobileOpen(): boolean {
        return newButton.getAttribute('aria-expanded') === 'true';
      }

      newButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (isMobileOpen()) {
          closeMobileMenu();
        } else {
          newButton.setAttribute('aria-expanded', 'true');
          mobileMenu!.classList.remove('hidden');
          const icon = newButton.querySelector('svg');
          if (icon) {
            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />';
          }
        }
      });

      // Escape closes mobile menu
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isMobileOpen()) {
          closeMobileMenu();
          newButton.focus();
        }
      });

      // Click outside closes mobile menu
      document.addEventListener('click', (e) => {
        if (isMobileOpen() && !mobileMenu!.contains(e.target as Node) && !newButton.contains(e.target as Node)) {
          closeMobileMenu();
        }
      });
    }
  }

  // Run on initial load
  document.addEventListener('DOMContentLoaded', initHeader);

  // Also run on Astro page transitions (SPA mode)
  document.addEventListener('astro:page-load', initHeader);
</script>
