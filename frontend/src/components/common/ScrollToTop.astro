---
/**
 * ScrollToTop Component
 * GENERATIVA - AI Agents Platform
 *
 * Floating button that appears when user scrolls down
 * Allows quick navigation back to the top of the page
 *
 * Design:
 * - Gradient background matching brand (cyan→purple)
 * - Smooth fade in/out animation
 * - Fixed position, responsive placement
 * - Accessible with keyboard and screen readers
 */

interface Props {
  locale?: 'ro' | 'en';
}

const { locale = 'ro' } = Astro.props;

const labels = {
  ro: 'Înapoi sus',
  en: 'Back to top'
};

const ariaLabel = labels[locale];
---

<button
  id="scroll-to-top"
  type="button"
  aria-label={ariaLabel}
  title={ariaLabel}
  class="scroll-to-top-btn"
>
  <!-- Arrow up icon -->
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2.5"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="w-5 h-5 sm:w-6 sm:h-6"
    aria-hidden="true"
  >
    <polyline points="18 15 12 9 6 15"></polyline>
  </svg>
</button>

<style>
  .scroll-to-top-btn {
    /* Position - fixed bottom right */
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 50;

    /* Size */
    width: 3rem;
    height: 3rem;

    /* Appearance — Flat amber accent */
    background: #F59E0B;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;

    /* Flexbox for centering icon */
    display: flex;
    align-items: center;
    justify-content: center;

    /* Shadow for depth */
    box-shadow:
      0 4px 14px rgba(245, 158, 11, 0.3),
      0 2px 6px rgba(245, 158, 11, 0.15);

    /* Initial state - hidden */
    opacity: 0;
    visibility: hidden;
    transform: translateY(1rem) scale(0.9);

    /* Smooth transitions */
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease,
      transform 0.3s ease,
      box-shadow 0.2s ease;
  }

  /* Visible state */
  .scroll-to-top-btn.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  /* Hover state */
  .scroll-to-top-btn:hover {
    background: #D97706;
    box-shadow:
      0 6px 20px rgba(245, 158, 11, 0.4),
      0 4px 10px rgba(245, 158, 11, 0.25);
    transform: translateY(-2px) scale(1.05);
  }

  /* Active/pressed state */
  .scroll-to-top-btn:active {
    transform: translateY(0) scale(0.98);
  }

  /* Focus state for accessibility */
  .scroll-to-top-btn:focus {
    outline: none;
  }

  .scroll-to-top-btn:focus-visible {
    outline: 2px solid white;
    outline-offset: 2px;
    box-shadow:
      0 6px 20px rgba(245, 158, 11, 0.4),
      0 4px 10px rgba(245, 158, 11, 0.25),
      0 0 0 4px rgba(245, 158, 11, 0.3);
  }

  /* Tablet - slightly larger */
  @media (min-width: 640px) {
    .scroll-to-top-btn {
      width: 3.25rem;
      height: 3.25rem;
      bottom: 2rem;
      right: 2rem;
    }
  }

  /* Desktop - larger with more spacing */
  @media (min-width: 1024px) {
    .scroll-to-top-btn {
      width: 3.5rem;
      height: 3.5rem;
      bottom: 2.5rem;
      right: 2.5rem;
    }
  }

  /* Large screens - even more spacing from edge */
  @media (min-width: 1280px) {
    .scroll-to-top-btn {
      right: 3rem;
    }
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .scroll-to-top-btn {
      transition: opacity 0.15s ease;
      transform: none !important;
    }

    .scroll-to-top-btn.visible {
      transform: none !important;
    }

    .scroll-to-top-btn:hover {
      transform: none !important;
    }
  }
</style>

<script>
  /**
   * ScrollToTop functionality
   *
   * - Shows button after scrolling 400px
   * - Smooth scroll to top on click
   * - Throttled scroll listener for performance
   */

  (function() {
    'use strict';

    const buttonEl = document.getElementById('scroll-to-top');
    if (!buttonEl) return;

    // TypeScript now knows button is never null in this scope
    const button: HTMLElement = buttonEl;

    const SCROLL_THRESHOLD = 400; // px before button appears
    const COOKIE_NAME = 'generativa_cookie_consent';
    const MOBILE_BREAKPOINT = 640; // px - below this, wait for cookie banner

    let isVisible = false;
    let ticking = false;
    let cookieBannerDismissed = false;

    /**
     * Check if we're on a mobile device (narrow screen)
     * On mobile, we need to wait for cookie banner to avoid overlap
     * On desktop/tablet, elements don't overlap so we can show immediately
     */
    function isMobileView(): boolean {
      return window.innerWidth < MOBILE_BREAKPOINT;
    }

    /**
     * Check if cookie consent has been given (banner is dismissed)
     */
    function checkCookieConsent(): boolean {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${COOKIE_NAME}=`);
      if (parts.length === 2) {
        return true; // Cookie exists, banner was dismissed
      }
      return false;
    }

    /**
     * Update button visibility based on scroll position
     * On mobile: also check if cookie banner is dismissed (to avoid overlap)
     * On desktop/tablet: show immediately when scrolled (no overlap issue)
     */
    function updateButtonVisibility(): void {
      const scrollY = window.scrollY || window.pageYOffset;
      const scrolledEnough = scrollY > SCROLL_THRESHOLD;

      // On mobile, wait for cookie banner. On desktop, show immediately.
      const canShow = isMobileView() ? cookieBannerDismissed : true;
      const shouldBeVisible = scrolledEnough && canShow;

      if (shouldBeVisible !== isVisible) {
        isVisible = shouldBeVisible;
        button.classList.toggle('visible', isVisible);
      }
    }

    /**
     * Throttled scroll handler using requestAnimationFrame
     */
    function onScroll(): void {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateButtonVisibility();
          ticking = false;
        });
        ticking = true;
      }
    }

    /**
     * Scroll to top with smooth animation
     */
    function scrollToTop(): void {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });

      // Focus on skip link or first focusable element for accessibility
      const skipLink = document.querySelector('a[href="#main-content"]') as HTMLElement;
      if (skipLink) {
        // Small delay to allow scroll to complete
        setTimeout(() => {
          skipLink.focus({ preventScroll: true });
        }, 500);
      }
    }

    /**
     * Handle window resize - recheck visibility
     * (in case user resizes from mobile to desktop or vice versa)
     */
    function onResize(): void {
      updateButtonVisibility();
    }

    // Event listeners
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize, { passive: true });
    button.addEventListener('click', scrollToTop);

    // Listen for cookie banner being dismissed
    window.addEventListener('cookieBannerHidden', () => {
      cookieBannerDismissed = true;
      updateButtonVisibility();
    });

    // Initial check - cookie consent already given?
    cookieBannerDismissed = checkCookieConsent();
    updateButtonVisibility();

    // Cleanup for SPA navigation (Astro)
    document.addEventListener('astro:before-preparation', () => {
      window.removeEventListener('scroll', onScroll);
      window.removeEventListener('resize', onResize);
      button.removeEventListener('click', scrollToTop);
    });
  })();
</script>
